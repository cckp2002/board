<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì¡°ìŒ¤ì˜ ìŠ¤ë§ˆíŠ¸ ì—…ë¬´ ë³´ë“œ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ìŠ¤í¬ë¡¤ë°” */
    * { scrollbar-width: thin; scrollbar-color: #64748b #0b0f1a; }
    ::-webkit-scrollbar { height: 8px; width: 8px; }
    ::-webkit-scrollbar-thumb { background: #64748b; border-radius: 8px; }
    ::-webkit-scrollbar-track { background: #0b0f1a; }

    /* ìœ í‹¸ */
    .btn { padding:.5rem .75rem; border-radius:.375rem; border:1px solid rgb(255 255 255 / .15); background:rgb(255 255 255 / .06); transition:.2s; font-size:.875rem;}
    .btn:hover{ background:rgb(255 255 255 / .12);}
    .btn-ghost { padding:.5rem .5rem; border-radius:.375rem;}
    .btn-ghost:hover{ background:rgb(255 255 255 /.08);}
    .btn-danger { padding:.5rem .75rem; border-radius:.375rem; border:1px solid rgb(248 113 113 / .4); background:rgb(248 113 113 / .2); color:#fecaca;}
    .btn-danger:hover{ background:rgb(248 113 113 / .3);}
    .icon { width: 18px; height: 18px; }
    .grid-auto { display: grid; grid-template-columns: repeat(auto-fill,minmax(340px,1fr)); gap: 20px; }
    .tabs-scroll { display:flex; flex-wrap: wrap; gap: 12px; max-height: 260px; overflow-y: auto; }
    .ql-scroll { max-height: 360px; overflow-y: auto; }
    .chip-edit input[type="color"], .color-input { width: 32px; height: 32px; padding: 0; border: none; background: transparent; }
    .range-tight { width: 7rem; } @media (min-width:768px){ .range-tight{ width: 8rem; } }
    .flex-wrap-safe{ display:flex; flex-wrap:wrap; align-items:center; gap:.5rem; }
    .chip,.chip-edit{ max-width:100%; }
    .chip-edit input[type="text"], .chip-edit input[type="url"]{ min-width:0; }
  </style>
</head>
<body class="min-h-screen bg-[#0b0f1a] text-gray-100 p-4 md:p-8">
  <!-- í—¤ë” -->
  <div class="max-w-7xl mx-auto flex items-center justify-between gap-4 mb-6">
    <div class="flex items-start md:items-center gap-3 md:gap-4">
      <!-- í¸ì§‘ ê°€ëŠ¥í•œ ê·¸ë¼ë°ì´ì…˜ íƒ€ì´í‹€ -->
      <div id="titleDisplay" contenteditable="true"
           class="leading-tight text-3xl md:text-4xl font-extrabold bg-gradient-to-r from-emerald-400 via-sky-400 to-indigo-400 bg-clip-text text-transparent drop-shadow">
      </div>
      <div class="flex items-center gap-2">
        <button id="settingsBtn" class="btn-ghost" title="ì„¤ì •">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 5 15.4a1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.6c.32 0 .63-.1.9-.26.27-.17.5-.41.61-.73V3a2 2 0 1 1 4 0v.09c.04.58.39 1.1.91 1.42.27.17.58.26.9.26a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9c0 .32.1 .63.26 .9 .17 .27 .41 .5 .73 .61H21a2 2 0 1 1 0 4h-.09c-.58 .04 -1.1 .39 -1.42 .91 -.17 .27 -.26 .58 -.26 .9z"/></svg>
        </button>
        <button id="editToggle" class="btn-ghost" title="í¸ì§‘ ëª¨ë“œ">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 1 1 3 3L7 19l-4 1 1-4Z"/></svg>
        </button>
        <button id="exportBtn" class="btn-ghost" title="ë°±ì—… ë‚´ë³´ë‚´ê¸°">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><path d="M7 10l5 5 5-5"/><path d="M12 15V3"/></svg>
        </button>
        <input id="importInput" type="file" accept="application/json" class="hidden" />
        <button id="importBtn" class="btn-ghost" title="ë°±ì—… ë¶ˆëŸ¬ì˜¤ê¸°">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><path d="M7 10l5-5 5 5"/><path d="M12 15V3"/></svg>
        </button>
      </div>
    </div>
    <div class="text-xs md:text-sm opacity-60">ê°œë°œ ì¡°ì² ì—°T</div>
  </div>

  <!-- ë³¸ë¬¸ ë ˆì´ì•„ì›ƒ -->
  <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-4 gap-6">
    <!-- ì™¼ìª½: ê²€ìƒ‰/ì‹œê³„/ë‚ ì”¨/ë‰´ìŠ¤/ëª…ì–¸ -->
    <aside class="space-y-6">
      <!-- Google ê²€ìƒ‰ -->
      <div class="bg-white/5 border border-white/10 rounded-2xl">
        <div class="p-3 border-b border-white/10 font-semibold text-base">ê²€ìƒ‰</div>
        <form id="gForm" class="p-3 flex items-center gap-2">
          <input id="gQuery" class="flex-1 h-10 px-3 rounded-md bg-white/90 text-black border border-white/50" placeholder="Google ê²€ìƒ‰" />
          <button class="btn">ê²€ìƒ‰</button>
        </form>
      </div>

      <!-- ì‹œê³„ -->
      <div class="bg-white/5 border border-white/10 rounded-2xl">
        <div class="p-3 border-b border-white/10 flex items-center justify-between">
          <div class="font-semibold text-base">ì‹œê³„</div>
          <button id="clkRefresh" class="btn-ghost">âŸ³</button>
        </div>
        <div class="p-5 flex items-end justify-between">
          <div>
            <div id="clkTime" class="text-3xl font-bold tracking-tight">--:--</div>
            <div id="clkDate" class="text-sm opacity-80">----</div>
          </div>
          <div id="clkTz" class="text-xs opacity-70">Asia/Seoul</div>
        </div>
      </div>

      <!-- ë‚ ì”¨ -->
      <div class="bg-white/5 border border-white/10 rounded-2xl">
        <div class="p-3 border-b border-white/10 flex items-center justify-between">
          <div class="font-semibold text-base">ë‚ ì”¨</div>
          <div class="flex items-center gap-2">
            <button id="wxUseGeo" class="btn text-xs">í˜„ì¬ìœ„ì¹˜</button>
            <button id="wxRefresh" class="btn-ghost">âŸ³</button>
          </div>
        </div>
        <div class="p-4 space-y-2">
          <div class="text-sm opacity-80">ìœ„ì¹˜: <span id="wxLoc">(ë¯¸ì„¤ì •)</span></div>
          <div class="text-2xl font-bold"><span id="wxTemp">--</span>Â°<span id="wxUnit">C</span></div>
          <div class="text-sm opacity-90" id="wxDesc">-</div>
          <div class="text-xs opacity-70" id="wxMeta">í’ì† -- m/s â€¢ ì²´ê° --Â°</div>
        </div>
      </div>

      <!-- ë‰´ìŠ¤(ì£¼ì œ ì„ íƒ ê°€ëŠ¥) -->
      <div class="bg-white/5 border border-white/10 rounded-2xl">
        <div class="p-3 border-b border-white/10 flex items-center justify-between">
          <div class="font-semibold text-base">ë‰´ìŠ¤ í—¤ë“œë¼ì¸</div>
          <div class="flex items-center gap-2">
            <button id="newsSettingsBtn" class="btn-ghost" title="ì£¼ì œ ì„¤ì •">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 5 15.4a1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.6c.32 0 .63-.1.9-.26.27-.17.5-.41.61-.73V3a2 2 0 1 1 4 0v.09c.04.58.39 1.1.91 1.42.27.17.58.26.9.26a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9c0 .32.1 .63.26 .9 .17 .27 .41 .5 .73 .61H21a2 2 0 1 1 0 4h-.09c-.58 .04 -1.1 .39 -1.42 .91 -.17 .27 -.26 .58 -.26 .9z"/></svg>
            </button>
            <button id="newsRefresh" class="btn-ghost">âŸ³</button>
          </div>
        </div>
        <div class="p-3 space-y-2 ql-scroll max-h-[340px]" id="newsList">
          <div class="text-xs opacity-60">ê´€ì‹¬ ë¶„ì•¼ì˜ ìµœì‹  í—¤ë“œë¼ì¸ì„ ê°€ì ¸ì˜µë‹ˆë‹¤â€¦</div>
        </div>
      </div>

      <!-- ëª…ì–¸ -->
      <div class="bg-white/5 border border-white/10 rounded-2xl">
        <div class="p-3 border-b border-white/10 flex items-center justify-between">
          <div class="font-semibold text-base">ëª…ì–¸ Â· ê²©ì–¸</div>
          <button id="quoteRefresh" class="btn-ghost">âŸ³</button>
        </div>
        <div class="p-4">
          <div id="quoteText" class="text-sm leading-relaxed"></div>
          <div id="quoteAuth" class="mt-2 text-xs opacity-70"></div>
        </div>
      </div>
    </aside>

    <!-- ê°€ìš´ë° 2ì—´: ì¹´í…Œê³ ë¦¬/íƒ­ -->
    <div class="lg:col-span-2">
      <div id="categoryGrid" class="grid-auto"></div>
      <div class="mt-4">
        <button id="addCategory" class="hidden btn" style="background:rgb(16 185 129 / .8)">+ ë°•ìŠ¤ ì¶”ê°€</button>
      </div>
    </div>

    <!-- ì˜¤ë¥¸ìª½: ë‹¬ë ¥ / ì˜¤ëŠ˜ í•  ì¼ / ë©”ëª¨ / ë¹ ë¥¸íƒ­ -->
    <div class="space-y-6">
      <!-- ë‹¬ë ¥ -->
      <div class="bg-white/5 border border-white/10 rounded-2xl">
        <div class="p-3 border-b border-white/10 flex items-center justify-between">
          <div class="font-semibold text-base">ë‹¬ë ¥</div>
          <div class="flex items-center gap-2">
            <button id="prevMonth" class="btn">ì´ì „</button>
            <div id="calLabel" class="text-sm opacity-90"></div>
            <button id="nextMonth" class="btn">ë‹¤ìŒ</button>
          </div>
        </div>
        <div class="p-3">
          <div class="grid grid-cols-7 gap-1 text-center text-xs opacity-80 mb-1">
            <div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div>í† </div><div>ì¼</div>
          </div>
          <div id="calGrid" class="grid grid-cols-7 gap-1"></div>
        </div>
      </div>

      <!-- ì˜¤ëŠ˜ í•  ì¼ -->
      <div class="rounded-2xl border border-amber-400/30 bg-amber-500/15">
        <div class="p-3 border-b border-amber-400/30 flex items-center justify-between">
          <div class="font-semibold text-base text-amber-200">ì˜¤ëŠ˜ í•  ì¼</div>
          <button id="todoClearDone" class="btn text-xs">ì™„ë£Œ ì •ë¦¬</button>
        </div>
        <div class="p-3 space-y-3">
          <div class="flex items-center gap-2">
            <input id="todoInput" class="flex-1 h-10 px-3 rounded-md bg-white/90 text-black border border-white/50" placeholder="í•  ì¼ì„ ì…ë ¥í•˜ê³  Enter" />
            <button id="todoAdd" class="btn" style="background:rgb(245 158 11 / .6); color:#fff">ì¶”ê°€</button>
          </div>
          <div id="todoList" class="space-y-2 max-h-[220px] overflow-y-auto"></div>
        </div>
      </div>

      <!-- ë©”ëª¨ -->
      <div class="bg-white/5 border border-white/10 rounded-2xl">
        <div class="p-3 border-b border-white/10 font-semibold text-base">ë©”ëª¨ì¥</div>
        <div class="p-3"><textarea id="memo" class="w-full min-h-[160px] rounded-xl bg-white/10 border border-white/20 p-3" placeholder="ì¤‘ìš”í•œ ë©”ëª¨ë¥¼ ì ì–´ì¤˜."></textarea></div>
      </div>

      <!-- ë¹ ë¥¸ íƒ­ ì¶”ê°€ -->
      <div class="bg-white/5 border border-white/10 rounded-2xl">
        <div class="p-3 border-b border-white/10 font-semibold text-base flex items-center gap-2">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          ë¹ ë¥¸ íƒ­ ì¶”ê°€
        </div>
        <div class="p-3 space-y-3">
          <div class="grid gap-1">
            <label class="text-sm opacity-80">íƒ­ ì´ë¦„</label>
            <input id="qaLabel" class="rounded-md h-10 bg-white/10 border border-white/20 px-2" placeholder="ì˜ˆ: ì—…ë¬´í¬í„¸" />
          </div>
          <div class="grid gap-1">
            <label class="text-sm opacity-80">ë§í¬(URL)</label>
            <input id="qaUrl" class="rounded-md h-10 bg-white/10 border border-white/20 px-2" placeholder="https://" />
          </div>
          <div class="flex items-center gap-3">
            <div class="grid gap-1">
              <label class="text-sm opacity-80">ì¹´í…Œê³ ë¦¬</label>
              <select id="qaCat" class="h-10 rounded-md bg-white/10 border border-white/20 px-2"></select>
            </div>
            <div class="grid gap-1">
              <label class="text-sm opacity-80">ìƒ‰</label>
              <input id="qaColor" type="color" value="#ffffff" class="color-input" />
            </div>
          </div>
          <button id="qaAdd" class="w-full btn" style="background:rgb(16 185 129 / .8)">ì¶”ê°€</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ì¼ì • ëª¨ë‹¬ -->
  <div id="eventModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm items-end md:items-center justify-center p-4 z-50">
    <div class="w-full max-w-lg bg-[#111827] border border-white/10 rounded-2xl shadow-2xl">
      <div class="p-4 border-b border-white/10 flex items-center justify-between">
        <div class="font-semibold" id="eventDateLabel"></div>
        <div class="flex items-center gap-2">
          <button id="eventSave" class="btn">ì €ì¥</button>
          <button id="eventClose" class="btn-ghost">ë‹«ê¸°</button>
        </div>
      </div>
      <div class="p-4 space-y-3">
        <div class="flex items-center gap-2">
          <input id="eventText" class="flex-1 h-10 px-2 rounded-md bg-white/10 border border-white/20" placeholder="ì¼ì • ë‚´ìš©" />
          <input id="eventTime" type="time" class="w-28 h-10 px-2 rounded-md bg-white/10 border border-white/20" />
          <input id="eventColor" type="color" value="#f59e0b" title="ìƒ‰ìƒ" />
          <button id="eventAdd" class="btn" style="background:rgb(16 185 129 / .8)">ì¶”ê°€</button>
        </div>
        <div id="eventList" class="space-y-2"></div>
      </div>
    </div>
  </div>

  <!-- ë‰´ìŠ¤ ì£¼ì œ ì„¤ì • ëª¨ë‹¬ -->
  <div id="newsModal" class="hidden fixed inset-0 bg-black/50 items-center justify-center p-4 z-40">
    <div class="w-full max-w-md bg-[#0f172a] border border-white/10 rounded-2xl p-4">
      <div class="flex items-center justify-between mb-3">
        <div class="font-semibold">ê´€ì‹¬ ë‰´ìŠ¤ ì£¼ì œ ì„ íƒ</div>
        <button id="newsClose" class="btn-ghost">ë‹«ê¸°</button>
      </div>
      <div id="newsTopics" class="grid grid-cols-2 gap-2 text-sm"></div>
      <div class="mt-4 flex justify-end gap-2">
        <button id="newsSave" class="btn" style="background:rgb(16 185 129 / .8)">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ì„¤ì • íŒ¨ë„ -->
  <div id="settingsPanel" class="hidden fixed inset-0 z-40">
    <div id="settingsBackdrop" class="flex-1 bg-black/50"></div>
    <div class="absolute right-0 top-0 bottom-0 w-full max-w-md bg-[#0f172a] border-l border-white/10 p-4 overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <div class="text-lg font-semibold">ì„¤ì •</div>
        <button id="settingsClose" class="btn-ghost">ë‹«ê¸°</button>
      </div>
      <div class="space-y-4">
        <div class="grid gap-2">
          <label class="text-sm opacity-80">ì „ì—­ ê°•ì¡°(íˆ¬ëª…ë„)</label>
          <input id="accentOpacity" type="range" min="30" max="100" value="95" class="range-tight" />
          <div class="text-xs opacity-70">ê° íƒ­/ë°•ìŠ¤ì˜ ê°œë³„ íˆ¬ëª…ë„ë„ ë³„ë„ë¡œ ì¡°ì ˆ ê°€ëŠ¥. ì´ ê°’ì€ ê¸°ë³¸ ê°•ì¡°ê°.</div>
        </div>
        <div class="text-xs opacity-70">ë°ì´í„°ëŠ” ë¸Œë¼ìš°ì € LocalStorageì— ì €ì¥ë¼. ë‹¤ë¥¸ PCë¡œ ì˜®ê¸¸ ë• ìƒë‹¨ì˜ ë°±ì—…/ë¶ˆëŸ¬ì˜¤ê¸° ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ì¤˜.</div>
      </div>
    </div>
  </div>

  <script>
    const $ = (s)=>document.querySelector(s);
    const $$ = (s)=>Array.from(document.querySelectorAll(s));
    const cryptoId = ()=>Math.random().toString(36).slice(2,9);
    const hexToRgba=(hex,a=1)=>{const c=hex.replace('#','');const v=parseInt(c.length===3?c.split('').map(x=>x+x).join(''):c,16);const r=(v>>16)&255,g=(v>>8)&255,b=v&255;return`rgba(${r}, ${g}, ${b}, ${a})`;}
    const formatDate=(d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const escapeHtml=(t='')=>t.replace(/[&<>\"']/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s]));

    const LS={get(k,def){try{const r=localStorage.getItem(k);return r?JSON.parse(r):def}catch{return def}},set(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch{}}};

    let state={
      title:LS.get('board:title','ì¡°ìŒ¤ì˜ ìŠ¤ë§ˆíŠ¸ ì—…ë¬´ ë³´ë“œ'),
      categories:LS.get('board:categories',[
        {id:'fav',name:'ì¦ê²¨ì°¾ê¸°',color:'#FFD54F',alpha:0.85,system:true},
        {id:'school',name:'í•™êµ ì—…ë¬´',color:'#4FC3F7',alpha:0.9},
        {id:'ai',name:'ì¸ê³µì§€ëŠ¥',color:'#A5D6A7',alpha:0.9},
        {id:'edtech',name:'ì—ë“€í…Œí¬',color:'#CE93D8',alpha:0.9},
        {id:'search',name:'ê²€ìƒ‰/ì‡¼í•‘',color:'#FFAB91',alpha:0.9},
        {id:'webapp',name:'ì›¹ì•± ê°œë°œ',color:'#90CAF9',alpha:0.9},
        {id:'etc',name:'ê¸°íƒ€ ë„êµ¬',color:'#B0BEC5',alpha:0.9},
      ]),
      tabs:LS.get('board:tabs',[
        {id:cryptoId(),label:'Google',url:'https://www.google.com',color:'#ffffff',alpha:1,categoryId:'search',starred:false},
        {id:cryptoId(),label:'Naver',url:'https://www.naver.com',color:'#ffffff',alpha:1,categoryId:'search',starred:false},
        {id:cryptoId(),label:'ChatGPT',url:'https://chat.openai.com',color:'#ffffff',alpha:1,categoryId:'ai',starred:true},
      ]),
      memo:LS.get('board:memo',''),
      events:LS.get('board:events',{}), // { 'YYYY-MM-DD': [{id,text,time,color,notified}] }
      editMode:LS.get('board:editMode',false),
      accentOpacity:LS.get('board:accentOpacity',0.95),
      widgets:LS.get('board:widgets',{
        weather:{lat:35.5384,lon:129.3114,name:'ìš¸ì‚°',unit:'C'},
        news:{topics:['education','history','major'],limit:8}
      }),
      todos:LS.get('board:todos',[])
    };
    const saveAll=()=>{LS.set('board:title',state.title);LS.set('board:categories',state.categories);LS.set('board:tabs',state.tabs);LS.set('board:memo',state.memo);LS.set('board:events',state.events);LS.set('board:editMode',state.editMode);LS.set('board:accentOpacity',state.accentOpacity);LS.set('board:widgets',state.widgets);LS.set('board:todos',state.todos);}

    if(window.Notification&&Notification.permission==='default'){Notification.requestPermission().catch(()=>{});}
    setInterval(()=>{try{const now=new Date();const key=formatDate(now);(state.events[key]||[]).forEach(ev=>{if(!ev.notified&&ev.time){const[h,m]=ev.time.split(':').map(Number);const d=new Date(now.getFullYear(),now.getMonth(),now.getDate(),h||0,m||0,0);if(now>=d){if(window.Notification&&Notification.permission==='granted'){new Notification('ì¼ì • ì•Œë¦¼',{body:ev.text});}else{alert('ì¼ì • ì•Œë¦¼: '+ev.text);}ev.notified=true;saveAll();}}});}catch{}},60000);

    const categoryGrid=$('#categoryGrid'); const addCategoryBtn=$('#addCategory');

    function render(){
      $('#titleDisplay').textContent=state.title;
      addCategoryBtn.classList.toggle('hidden',!state.editMode);

      const qaCat=$('#qaCat'); if(qaCat) qaCat.innerHTML=state.categories.filter(c=>c.id!=='fav').map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');

      const favCat=state.categories.find(c=>c.id==='fav'); const favTabs=state.tabs.filter(t=>t.starred);
      const others=state.categories.filter(c=>c.id!=='fav');
      categoryGrid.innerHTML=[
        CategoryCard({cat:favCat,allowDelete:false,children:TabsWrap(favTabs,favCat.id)}),
        ...others.map(cat=>CategoryCard({cat,allowDelete:!cat.system,children:TabsWrap(state.tabs.filter(t=>t.categoryId===cat.id),cat.id)}))
      ].join('');

      renderCalendar(); $('#memo').value=state.memo; renderTodos();
      startClock(); fetchWeather(); pickQuote(); fetchNews();
      bindDnD();
    }

    function TabsWrap(tabs,catId){
      if(tabs.length===0&&!state.editMode) return `<div class="text-xs opacity-70">(ë¹„ì–´ ìˆìŒ)</div>`;
      const chips=tabs.map(t=>TabChip(t,catId)).join('');
      return `<div class="tabs-scroll" data-catwrap="${catId}">${chips}${tabs.length===0&&state.editMode?`<span class='text-xs opacity-70'>"íƒ­ ì¶”ê°€"ë¥¼ ëˆŒëŸ¬ ìƒˆ íƒ­ì„ ë§Œë“¤ì–´ì¤˜.</span>`:''}</div>`;
    }

    function CategoryCard({cat,allowDelete,children}){
      const bg=hexToRgba(cat.color||'#fff',cat.alpha??0.9); const border=hexToRgba(cat.color||'#fff',1);
      return `
      <div class="bg-transparent border border-white/10 rounded-2xl shadow-md">
        <div class="p-3 border-b border-white/10 flex-wrap-safe">
          <div class="flex items-center gap-3">
            <div class="w-4 h-4 rounded" style="background:${border}"></div>
            ${state.editMode?`<input data-cat="${cat.id}" class="cat-name h-8 w-[14ch] rounded-md bg-white/5 border border-white/10 px-2" value="${escapeHtml(cat.name)}" />`:`<div class="text-lg font-semibold">${escapeHtml(cat.name)}</div>`}
          </div>
          ${state.editMode?`
          <div class="flex-wrap-safe">
            <input data-cat-color="${cat.id}" type="color" value="${cat.color||'#ffffff'}" title="ë°•ìŠ¤ ìƒ‰" />
            <div class="flex items-center gap-2 text-xs">
              <span class="opacity-70">íˆ¬ëª…ë„</span>
              <input data-cat-alpha="${cat.id}" type="range" min="10" max="100" value="${Math.round((cat.alpha??1)*100)}" class="range-tight" />
            </div>
            <button data-add-tab="${cat.id}" class="btn">+ íƒ­</button>
            ${allowDelete?`<button data-del-cat="${cat.id}" class="btn-danger">ì‚­ì œ</button>`:''}
          </div>`:''}
        </div>
        <div class="p-3">
          <div class="p-3 rounded-xl border overflow-hidden" style="background:${bg}; border-color:${border}">
            ${children}
          </div>
        </div>
      </div>`;
    }

    function TabChip(t,catId){
      const bg=hexToRgba(t.color||'#fff',(t.alpha??1)*state.accentOpacity);
      return `
        <div class="chip flex-wrap-safe" draggable="true" data-tab="${t.id}" data-cat="${catId}">
          <a href="${encodeURI(t.url)}" target="_blank" rel="noreferrer" title="${escapeHtml(t.url)}"
             class="px-3 py-2 rounded-lg text-sm font-medium shadow border border-black/10 hover:opacity-90 transition"
             style="background:${bg}; color:#111">
            <span class="inline-flex items-center gap-1">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
              ${escapeHtml(t.label)}
            </span>
          </a>
          <button class="btn-ghost" title="${t.starred?'ì¦ê²¨ì°¾ê¸° í•´ì œ':'ì¦ê²¨ì°¾ê¸° ì¶”ê°€'}" data-star="${t.id}">
            ${t.starred?`<svg class="icon text-yellow-400" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor"><polygon points="12 2 15 9 22 9 17 14 19 21 12 17 5 21 7 14 2 9 9 9"/></svg>`:`<svg class="icon text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15 9 22 9 17 14 19 21 12 17 5 21 7 14 2 9 9 9"/></svg>`}
          </button>
          ${state.editMode?`
            <div class="chip-edit flex-wrap-safe">
              <input data-tab-label="${t.id}" class="h-8 w-40 md:w-48 rounded bg-white/70 text-black px-2" value="${escapeHtml(t.label)}" />
              <input data-tab-url="${t.id}" class="h-8 w-56 md:w-80 rounded bg-white/70 text-black px-2" value="${escapeHtml(t.url)}" />
              <input data-tab-color="${t.id}" type="color" value="${t.color||'#ffffff'}" title="íƒ­ ìƒ‰" />
              <button class="btn-danger" data-del-tab="${t.id}">ì‚­ì œ</button>
            </div>
          `:''}
        </div>`;
    }

    // í—¤ë” & ë°±ì—…
    $('#titleDisplay').addEventListener('input',(e)=>{state.title=e.target.textContent||'';saveAll();});
    $('#editToggle').addEventListener('click',()=>{state.editMode=!state.editMode;saveAll();render();});
    $('#exportBtn').addEventListener('click',()=>{const data={...state};const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`board-backup-${Date.now()}.json`;a.click();URL.revokeObjectURL(url);});
    $('#importBtn').addEventListener('click',()=>$('#importInput').click());
    $('#importInput').addEventListener('change',(e)=>{const f=e.target.files&&e.target.files[0];if(!f)return;const r=new FileReader();r.onload=(ev)=>{try{const d=JSON.parse(ev.target.result);state={title:d.title??state.title,categories:d.categories??state.categories,tabs:d.tabs??state.tabs,memo:d.memo??state.memo,events:d.events??state.events,editMode:!!d.editMode,accentOpacity:d.accentOpacity??state.accentOpacity,widgets:d.widgets??state.widgets,todos:d.todos??state.todos};saveAll();render();}catch{alert('ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: JSON í˜•ì‹ì„ í™•ì¸í•´ì¤˜.')}};r.readAsText(f);});

    // ì¹´í…Œê³ ë¦¬/íƒ­
    addCategoryBtn.addEventListener('click',()=>{const id=cryptoId();state.categories.push({id,name:'ìƒˆ ë°•ìŠ¤',color:'#ffffff',alpha:0.95});saveAll();render();});
    categoryGrid.addEventListener('input',(e)=>{
      const t=e.target;
      if(t.matches('[data-cat]')){const id=t.getAttribute('data-cat');const c=state.categories.find(x=>x.id===id);if(c){c.name=t.value;saveAll();}}
      if(t.matches('[data-cat-color]')){const id=t.getAttribute('data-cat-color');const c=state.categories.find(x=>x.id===id);if(c){c.color=t.value;saveAll();render();}}
      if(t.matches('[data-cat-alpha]')){const id=t.getAttribute('data-cat-alpha');const c=state.categories.find(x=>x.id===id);if(c){c.alpha=(Number(t.value)||100)/100;saveAll();render();}}
      if(t.matches('[data-tab-label]')){const id=t.getAttribute('data-tab-label');const tab=state.tabs.find(x=>x.id===id);if(tab){tab.label=t.value;saveAll();}}
      if(t.matches('[data-tab-url]')){const id=t.getAttribute('data-tab-url');const tab=state.tabs.find(x=>x.id===id);if(tab){tab.url=t.value;saveAll();}}
      if(t.matches('[data-tab-color]')){const id=t.getAttribute('data-tab-color');const tab=state.tabs.find(x=>x.id===id);if(tab){tab.color=t.value;saveAll();render();}}
    });
    categoryGrid.addEventListener('click',(e)=>{
      const t=e.target.closest('[data-del-cat],[data-add-tab],[data-del-tab],[data-star]'); if(!t) return;
      if(t.hasAttribute('data-del-cat')){const id=t.getAttribute('data-del-cat');const c=state.categories.find(x=>x.id===id);if(!c)return;if(c.system)return alert('ì‹œìŠ¤í…œ ì¹´í…Œê³ ë¦¬ëŠ” ì‚­ì œí•  ìˆ˜ ì—†ì–´.');if(!confirm('ì´ ë°•ìŠ¤ë¥¼ ì‚­ì œí• ê¹Œ? ì•ˆì˜ íƒ­ë„ í•¨ê»˜ ì‚­ì œë¼.'))return;state.categories=state.categories.filter(x=>x.id!==id);state.tabs=state.tabs.filter(x=>x.categoryId!==id);saveAll();render();}
      if(t.hasAttribute('data-add-tab')){const id=t.getAttribute('data-add-tab');state.tabs.push({id:cryptoId(),label:'ìƒˆ íƒ­',url:'https://',color:'#ffffff',alpha:1,categoryId:id,starred:false});saveAll();render();}
      if(t.hasAttribute('data-del-tab')){const id=t.getAttribute('data-del-tab');state.tabs=state.tabs.filter(x=>x.id!==id);saveAll();render();}
      if(t.hasAttribute('data-star')){const id=t.getAttribute('data-star');const tab=state.tabs.find(x=>x.id===id);if(!tab)return;tab.starred=!tab.starred;saveAll();render();}
    });

    // ë¹ ë¥¸ íƒ­ ì¶”ê°€
    $('#qaAdd').addEventListener('click',()=>{const label=$('#qaLabel').value.trim();const url=$('#qaUrl').value.trim();const color=$('#qaColor').value;const categoryId=$('#qaCat').value;if(!label||!url)return alert('ì´ë¦„ê³¼ ë§í¬ë¥¼ ì…ë ¥í•´ì¤˜.');state.tabs.push({id:cryptoId(),label,url,color,alpha:1,categoryId,starred:false});$('#qaLabel').value='';$('#qaUrl').value='https://';saveAll();render();});

    // ë©”ëª¨
    $('#memo').addEventListener('input',(e)=>{state.memo=e.target.value;saveAll();});

    // ë‹¬ë ¥
    let calCurrent=new Date();
    function renderCalendar(){
      const y=calCurrent.getFullYear(),m=calCurrent.getMonth();
      $('#calLabel').textContent=`${y}ë…„ ${calCurrent.toLocaleString('ko-KR',{month:'long'})}`;
      const first=new Date(y,m,1),last=new Date(y,m+1,0),start=(first.getDay()+6)%7,days=last.getDate();const cells=[];for(let i=0;i<start;i++)cells.push(null);for(let d=1;d<=days;d++)cells.push(new Date(y,m,d));
      $('#calGrid').innerHTML=cells.map(dt=>{
        if(!dt)return`<div class="h-8"></div>`;
        const key=formatDate(dt); const dayEvents=state.events[key]||[];
        if(dayEvents.length){
          const col=dayEvents[0].color||'#f59e0b';
          const bg=hexToRgba(col, .7);
          return `<button data-day="${key}" class="h-8 rounded text-xs border border-white/20 font-semibold" style="background:${bg}; color:#111">${dt.getDate()}</button>`;
        }
        return `<button data-day="${key}" class="h-8 rounded text-xs hover:bg-white/10 border border-white/10 bg-white/5">${dt.getDate()}</button>`;
      }).join('');
    }
    $('#prevMonth').addEventListener('click',()=>{calCurrent=new Date(calCurrent.getFullYear(),calCurrent.getMonth()-1,1);renderCalendar();});
    $('#nextMonth').addEventListener('click',()=>{calCurrent=new Date(calCurrent.getFullYear(),calCurrent.getMonth()+1,1);renderCalendar();});
    $('#calGrid').addEventListener('click',(e)=>{const btn=e.target.closest('[data-day]');if(!btn)return;openEventModal(btn.getAttribute('data-day'));});

    // ì¼ì • ëª¨ë‹¬
    const eventModal=$('#eventModal'); let currentEventDate=null;
    function openEventModal(d){currentEventDate=d;$('#eventDateLabel').textContent=d+' ì¼ì •';$('#eventText').value='';$('#eventTime').value='';$('#eventColor').value='#f59e0b';renderEventList();eventModal.classList.remove('hidden');eventModal.classList.add('flex');}
    function closeEventModal(){eventModal.classList.add('hidden');eventModal.classList.remove('flex');}
    function renderEventList(){
      const list=state.events[currentEventDate]||[];
      if(!list.length){$('#eventList').innerHTML=`<div class='text-sm opacity-70'>ì•„ì§ ì¼ì •ì´ ì—†ì–´.</div>`;return;}
      $('#eventList').innerHTML=list.map(it=>`
        <div class="flex items-center justify-between bg-white/5 border border-white/10 rounded-lg p-2">
          <div class="text-sm flex items-center gap-2">
            <span class="inline-block w-3 h-3 rounded" style="background:${it.color||'#f59e0b'}"></span>
            <span class="font-medium">${it.time||'ì¢…ì¼'}</span> â€” ${escapeHtml(it.text)}
          </div>
          <button data-del-ev="${it.id}" class="btn-danger">ì‚­ì œ</button>
        </div>
      `).join('');
    }
    $('#eventAdd').addEventListener('click',()=>{
      const text=$('#eventText').value.trim();
      const time=$('#eventTime').value.trim();
      const color=$('#eventColor').value || '#f59e0b';
      if(!text) return;
      const list=state.events[currentEventDate]||[];
      list.push({id:cryptoId(),text,time,color,notified:false});
      state.events[currentEventDate]=list; saveAll();
      $('#eventText').value=''; $('#eventTime').value='';
      renderEventList(); renderCalendar();
    });
    $('#eventList').addEventListener('click',(e)=>{const btn=e.target.closest('[data-del-ev]');if(!btn)return;const id=btn.getAttribute('data-del-ev');state.events[currentEventDate]=(state.events[currentEventDate]||[]).filter(x=>x.id!==id);saveAll();renderEventList();renderCalendar();});
    $('#eventSave').addEventListener('click',closeEventModal); $('#eventClose').addEventListener('click',closeEventModal);

    // ì„¤ì •
    const settingsPanel=$('#settingsPanel'); $('#settingsBtn').addEventListener('click',()=>settingsPanel.classList.remove('hidden')); $('#settingsClose').addEventListener('click',()=>settingsPanel.classList.add('hidden')); $('#settingsBackdrop').addEventListener('click',()=>settingsPanel.classList.add('hidden'));
    const accentRange=$('#accentOpacity'); accentRange.value=Math.round((state.accentOpacity||0.95)*100); accentRange.addEventListener('input',(e)=>{state.accentOpacity=(Number(e.target.value)||95)/100;saveAll();render();});

    // ì‹œê³„
    let clkTimer=null; function startClock(){const tz='Asia/Seoul';const fT=new Intl.DateTimeFormat('ko-KR',{hour:'2-digit',minute:'2-digit',hour12:false,timeZone:tz});const fD=new Intl.DateTimeFormat('ko-KR',{dateStyle:'full',timeZone:tz});const tick=()=>{const now=new Date();$('#clkTime').textContent=fT.format(now);$('#clkDate').textContent=fD.format(now);$('#clkTz').textContent=tz;};if(clkTimer)clearInterval(clkTimer);tick();clkTimer=setInterval(tick,1000);} $('#clkRefresh')?.addEventListener('click',startClock);

    // ë‚ ì”¨
    const WMO={0:'ë§‘ìŒ',1:'ëŒ€ì²´ë¡œ ë§‘ìŒ',2:'êµ¬ë¦„ ì¡°ê¸ˆ',3:'íë¦¼',45:'ì•ˆê°œ',48:'ì°©ë¹™ ì•ˆê°œ',51:'ì´ìŠ¬ë¹„ ì•½í•¨',53:'ì´ìŠ¬ë¹„',55:'ì´ìŠ¬ë¹„ ê°•í•¨',56:'ì–¼ìŒ ì´ìŠ¬ë¹„ ì•½í•¨',57:'ì–¼ìŒ ì´ìŠ¬ë¹„ ê°•í•¨',61:'ë¹„ ì•½í•¨',63:'ë¹„',65:'ë¹„ ê°•í•¨',66:'ì–¼ìŒ ë¹„ ì•½í•¨',67:'ì–¼ìŒ ë¹„ ê°•í•¨',71:'ëˆˆ ì•½í•¨',73:'ëˆˆ',75:'ëˆˆ ê°•í•¨',77:'ì‹¸ë½ëˆˆ',80:'ì†Œë‚˜ê¸° ì•½í•¨',81:'ì†Œë‚˜ê¸°',82:'ì†Œë‚˜ê¸° ê°•í•¨',85:'ì†Œë‚™ëˆˆ ì•½í•¨',86:'ì†Œë‚™ëˆˆ ê°•í•¨',95:'ë‡Œìš°',96:'ë‡Œìš°(ìš°ë°• ì•½ê°„)',99:'ë‡Œìš°(ìš°ë°• ê°•í•¨)'};
    async function fetchWeather(){try{const {lat,lon,name,unit}=state.widgets.weather;if(!lat||!lon){$('#wxLoc').textContent='(ë¯¸ì„¤ì •)';return;}$('#wxLoc').textContent=name||`${lat.toFixed(3)}, ${lon.toFixed(3)}`;const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,apparent_temperature,weather_code,wind_speed_10m&timezone=auto`;const res=await fetch(url);const data=await res.json();const cur=data.current;const t=cur.temperature_2m;const app=cur.apparent_temperature;const code=cur.weather_code;const wind=cur.wind_speed_10m;const toU=(x)=>unit==='F'?Math.round(x*9/5+32):Math.round(x);$('#wxTemp').textContent=toU(t);$('#wxUnit').textContent=unit==='F'?'F':'C';$('#wxDesc').textContent=WMO[code]||'-';$('#wxMeta').textContent=`í’ì† ${wind} m/s â€¢ ì²´ê° ${toU(app)}Â°`;}catch{ $('#wxDesc').textContent='ë‚ ì”¨ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ì–´ìš”.';}}
    $('#wxRefresh')?.addEventListener('click',fetchWeather); $('#wxUseGeo')?.addEventListener('click',()=>{ if(!navigator.geolocation) return alert('ë¸Œë¼ìš°ì €ê°€ ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•Šì•„ìš”.'); navigator.geolocation.getCurrentPosition((pos)=>{state.widgets.weather.lat=pos.coords.latitude;state.widgets.weather.lon=pos.coords.longitude;state.widgets.weather.name='í˜„ì¬ìœ„ì¹˜';saveAll();fetchWeather();},()=>alert('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆì–´ìš”.'));});

    // ëª…ì–¸
    const QUOTES=[{t:'êµìœ¡ì˜ ëª©ì ì€ ë¹„ì–´ ìˆëŠ” ë¨¸ë¦¬ë¥¼ ì—´ë¦° ë¨¸ë¦¬ë¡œ ë°”ê¾¸ëŠ” ê²ƒì´ë‹¤.',a:'ë§ì½¤ í¬ë¸ŒìŠ¤'},{t:'ë°°ì›€ì€ ë§ˆìŒì„ ì§€ì¹˜ê²Œ í•˜ì§€ ì•ŠëŠ”ë‹¤.',a:'ë ˆì˜¤ë‚˜ë¥´ë„ ë‹¤ ë¹ˆì¹˜'},{t:'í–‰ë™ì€ ëª¨ë“  ì„±ê³µì˜ ê¸°ì´ˆì´ë‹¤.',a:'íŒŒë¸”ë¡œ í”¼ì¹´ì†Œ'},{t:'ì˜¤ëŠ˜ í•  ìˆ˜ ìˆëŠ” ì¼ì„ ë‚´ì¼ë¡œ ë¯¸ë£¨ì§€ ë§ˆë¼.',a:'ë²¤ì €ë¯¼ í”„ë­í´ë¦°'},{t:'ì„±ê³µì€ ì‘ì€ ë…¸ë ¥ì´ ë‚ ë§ˆë‹¤ ë°˜ë³µëœ ê²°ê³¼ì´ë‹¤.',a:'ë¡œë²„íŠ¸ ì½œë¦¬ì–´'},{t:'êµìœ¡ì´ ê°€ì¥ ê°•ë ¥í•œ ë¬´ê¸°ë‹¤. ì´ë¥¼ í†µí•´ ì„¸ìƒì„ ë°”ê¿€ ìˆ˜ ìˆë‹¤.',a:'ë„¬ìŠ¨ ë§Œë¸ë¼'}];
    function pickQuote(){const q=QUOTES[Math.floor(Math.random()*QUOTES.length)];$('#quoteText').textContent='â€œ'+q.t+'â€';$('#quoteAuth').textContent='â€” '+q.a;}
    $('#quoteRefresh')?.addEventListener('click',pickQuote);

    // ë‰´ìŠ¤ (Google News RSS via AllOrigins)
    const NEWS_CANDIDATES = [
      {key:'education', label:'êµìœ¡'},
      {key:'history',   label:'ì—­ì‚¬'},
      {key:'edtech',    label:'ì—ë“€í…Œí¬'},
      {key:'ai',        label:'ì¸ê³µì§€ëŠ¥'},
      {key:'policy',    label:'êµìœ¡ì •ì±…'},
      {key:'science',   label:'ê³¼í•™'},
      {key:'tech',      label:'ITÂ·í…Œí¬'},
      {key:'parenting', label:'í•™ë¶€ëª¨/ìœ¡ì•„'},
      {key:'local',     label:'ì§€ì—­'},
      {key:'world',     label:'ì„¸ê³„'}
    ];
    const NEWS_FEEDS={
      education:'https://news.google.com/rss/search?q=%EA%B5%90%EC%9C%A1&hl=ko&gl=KR&ceid=KR:ko',
      history:  'https://news.google.com/rss/search?q=%EC%97%AD%EC%82%AC&hl=ko&gl=KR&ceid=KR:ko',
      edtech:   'https://news.google.com/rss/search?q=%EC%97%90%EB%93%80%ED%85%8D&hl=ko&gl=KR&ceid=KR:ko',
      ai:       'https://news.google.com/rss/search?q=%EC%9D%B8%EA%B3%B5%EC%A7%80%EB%8A%A5&hl=ko&gl=KR&ceid=KR:ko',
      policy:   'https://news.google.com/rss/search?q=%EA%B5%90%EC%9C%A1%EC%A0%95%EC%B1%85&hl=ko&gl=KR&ceid=KR:ko',
      science:  'https://news.google.com/rss/search?q=%EA%B3%BC%ED%95%99&hl=ko&gl=KR&ceid=KR:ko',
      tech:     'https://news.google.com/rss/search?q=IT%20%ED%85%8C%ED%81%AC&hl=ko&gl=KR&ceid=KR:ko',
      parenting:'https://news.google.com/rss/search?q=%ED%95%99%EB%B6%80%EB%AA%A8%20%EC%9C%A1%EC%95%84&hl=ko&gl=KR&ceid=KR:ko',
      local:    'https://news.google.com/rss/search?q=%EC%A7%80%EC%97%AD%20%EC%86%8C%EC%8B%9D&hl=ko&gl=KR&ceid=KR:ko',
      world:    'https://news.google.com/rss/search?q=%EC%84%B8%EA%B3%84%20%EB%89%B4%EC%8A%A4&hl=ko&gl=KR&ceid=KR:ko',
      major:    'https://news.google.com/rss/search?q=%EC%82%AC%EA%B1%B4%20%EC%82%AC%EA%B3%A0&hl=ko&gl=KR&ceid=KR:ko'
    };
    async function fetchNews(){
      const box=$('#newsList'); if(!box) return; box.innerHTML=`<div class="text-xs opacity-60">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>`;
      try{
        const keys = state.widgets.news.topics;
        const feeds = keys.map(k=>NEWS_FEEDS[k]).filter(Boolean);
        const lim = state.widgets.news.limit || 8;
        const items=[];
        for(const feed of feeds){
          const prox='https://api.allorigins.win/raw?url='+encodeURIComponent(feed);
          const text=await (await fetch(prox)).text();
          const xml=new DOMParser().parseFromString(text,'text/xml');
          const nodes=Array.from(xml.querySelectorAll('item')).slice(0,lim);
          for(const n of nodes){
            items.push({title:n.querySelector('title')?.textContent||'', link:n.querySelector('link')?.textContent||'#', pub:n.querySelector('pubDate')?.textContent||''});
          }
        }
        items.sort((a,b)=> new Date(b.pub)-new Date(a.pub));
        const top=items.slice(0,lim);
        box.innerHTML=top.map(it=>`
          <a class='block p-2 rounded hover:bg-white/10 border border-white/10' href='${it.link}' target='_blank' rel='noreferrer'>
            <div class='text-sm'>${escapeHtml(it.title)}</div>
            <div class='text-[11px] opacity-60 mt-1'>${escapeHtml(it.pub)}</div>
          </a>`).join('');
      }catch{ box.innerHTML=`<div class='text-xs opacity-70'>í—¤ë“œë¼ì¸ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì–´ìš”. ë„¤íŠ¸ì›Œí¬ ë˜ëŠ” CORS ì •ì±…ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.</div>`; }
    }
    $('#newsRefresh')?.addEventListener('click',fetchNews);

    // ë‰´ìŠ¤ ì£¼ì œ ì„¤ì • ëª¨ë‹¬
    function openNewsSettings(){
      const cont = $('#newsTopics');
      const chosen = new Set(state.widgets.news.topics||[]);
      cont.innerHTML = NEWS_CANDIDATES.map(c=>{
        const chk = chosen.has(c.key) ? 'checked' : '';
        return `<label class="flex items-center gap-2 p-2 rounded bg-white/5 border border-white/10">
          <input type="checkbox" value="${c.key}" ${chk} />
          <span>${c.label}</span>
        </label>`;
      }).join('');
      $('#newsModal').classList.remove('hidden');
      $('#newsModal').classList.add('flex');
    }
    function closeNewsSettings(){
      $('#newsModal').classList.add('hidden');
      $('#newsModal').classList.remove('flex');
    }
    $('#newsSettingsBtn')?.addEventListener('click', openNewsSettings);
    $('#newsClose')?.addEventListener('click', closeNewsSettings);
    $('#newsSave')?.addEventListener('click', ()=>{
      const vals = Array.from($('#newsTopics').querySelectorAll('input[type="checkbox"]:checked')).map(i=>i.value);
      if (!vals.length) return alert('ìµœì†Œ í•œ ê°œì˜ ì£¼ì œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.');
      state.widgets.news.topics = vals; saveAll(); closeNewsSettings(); fetchNews();
    });

    // To-Do
    function renderTodos(){const box=$('#todoList');const arr=[...state.todos];const done=arr.filter(t=>t.done),todo=arr.filter(t=>!t.done);const row=(t)=>`<div class="flex items-center justify-between bg-white/5 border border-white/10 rounded-md px-3 py-2"><label class="flex items-center gap-2 flex-1"><input type="checkbox" ${t.done?'checked':''} data-todo-toggle="${t.id}" /><span class="${t.done?'line-through opacity-60':''}">${escapeHtml(t.text)}</span></label><button class="btn-ghost" data-todo-del="${t.id}">ğŸ—‘ï¸</button></div>`;box.innerHTML=todo.map(row).join('')+(done.length?`<div class="text-xs opacity-60 mt-2">ì™„ë£Œ ${done.length}ê°œ</div>${done.map(row).join('')}`:'');}
    $('#todoAdd').addEventListener('click',()=>{const v=$('#todoInput').value.trim();if(!v)return;state.todos.push({id:cryptoId(),text:v,done:false});$('#todoInput').value='';saveAll();renderTodos();});
    $('#todoInput').addEventListener('keydown',(e)=>{if(e.key==='Enter'){e.preventDefault();$('#todoAdd').click();}});
    $('#todoList').addEventListener('click',(e)=>{const del=e.target.closest('[data-todo-del]');const tog=e.target.closest('[data-todo-toggle]');if(del){const id=del.getAttribute('data-todo-del');state.todos=state.todos.filter(x=>x.id!==id);saveAll();renderTodos();}if(tog){const id=tog.getAttribute('data-todo-toggle');const t=state.todos.find(x=>x.id===id);if(!t)return;t.done=!t.done;saveAll();renderTodos();}});
    $('#todoClearDone').addEventListener('click',()=>{if(!state.todos.some(t=>t.done))return;if(!confirm('ì™„ë£Œ í•­ëª©ì„ ëª¨ë‘ ì •ë¦¬í• ê¹Œìš”?'))return;state.todos=state.todos.filter(t=>!t.done);saveAll();renderTodos();});

    // Drag & Drop for tabs
    let dragTabId=null;
    function bindDnD(){
      $$('.chip[data-tab]').forEach(chip=>{
        chip.addEventListener('dragstart',(e)=>{dragTabId=chip.dataset.tab;e.dataTransfer.setData('text/plain',dragTabId);chip.classList.add('opacity-70');});
        chip.addEventListener('dragend',()=>chip.classList.remove('opacity-70'));
        chip.addEventListener('dragover',(e)=>{e.preventDefault();chip.classList.add('ring-2','ring-emerald-400/60');});
        chip.addEventListener('dragleave',()=>chip.classList.remove('ring-2','ring-emerald-400/60'));
        chip.addEventListener('drop',(e)=>{e.preventDefault();chip.classList.remove('ring-2','ring-emerald-400/60');const targetCat=chip.closest('[data-catwrap]')?.dataset.catwrap;const targetId=chip.dataset.tab;const draggedId=dragTabId||e.dataTransfer.getData('text/plain');if(!draggedId||draggedId===targetId)return;moveTabBefore(draggedId,targetId,targetCat);saveAll();render();});
      });
      $$('.tabs-scroll[data-catwrap]').forEach(cont=>{
        cont.addEventListener('dragover',(e)=>{e.preventDefault();cont.classList.add('bg-white/10');});
        cont.addEventListener('dragleave',()=>cont.classList.remove('bg-white/10'));
        cont.addEventListener('drop',(e)=>{e.preventDefault();cont.classList.remove('bg-white/10');const catId=cont.dataset.catwrap;const draggedId=dragTabId||e.dataTransfer.getData('text/plain');if(!draggedId)return;moveTabToEnd(draggedId,catId);saveAll();render();});
      });
    }
    function moveTabBefore(dragId,targetId,targetCatId){const di=state.tabs.findIndex(t=>t.id===dragId);if(di<0)return;const ti=state.tabs.findIndex(t=>t.id===targetId);if(ti<0)return;const tab=state.tabs[di];tab.categoryId=targetCatId;state.tabs.splice(di,1);const nti=state.tabs.findIndex(t=>t.id===targetId);state.tabs.splice(nti,0,tab);}
    function moveTabToEnd(dragId,catId){const i=state.tabs.findIndex(t=>t.id===dragId);if(i<0)return;const tab=state.tabs[i];tab.categoryId=catId;state.tabs.splice(i,1);let pos=state.tabs.length;for(let j=state.tabs.length-1;j>=0;j--){if(state.tabs[j].categoryId===catId){pos=j+1;break;}}state.tabs.splice(pos,0,tab);}

    // Google ê²€ìƒ‰
    $('#gForm').addEventListener('submit',(e)=>{e.preventDefault();const q=$('#gQuery').value.trim();if(!q)return;window.open('https://www.google.com/search?q='+encodeURIComponent(q),'_blank','noopener');});

    // ì´ˆê¸° ë Œë”
    render();
  </script>
</body>
</html>
